<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KINAFLIX â€“ Browse by Genre or Umusobanuzi</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
  <style>
    :root {
      --primary: #e50914;
      --primary-dark: #b2070f;
      --primary-light: #ff3a2d;
      --dark: #141414;
      --light: #f4f4f4;
      --gray: #999;
      --dark-gray: #222;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      --content-box-shadow: 0 8px 20px rgba(0, 0, 0, 0.6);
      --spacing-base: 1rem;
      --spacing-sm: 0.5rem;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      line-height: 1.5;
      touch-action: manipulation;
      overflow-x: hidden;
      margin: 0;
      -webkit-font-smoothing: antialiased;
    }

    body.light-mode {
      background: var(--light);
      color: var(--dark);
    }

    .main-content {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    header {
      background: var(--dark);
      padding: var(--spacing-base) var(--spacing-sm);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
      transition: background 0.3s;
      flex-shrink: 0;
    }

    body.light-mode header {
      background: var(--light);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header-left, .header-right {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .back-btn {
      color: var(--light);
      text-decoration: none;
      font-size: 1.2rem;
      transition: color 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    body.light-mode .back-btn {
      color: var(--dark);
    }

    .back-btn:hover {
      color: var(--primary);
      transform: scale(1.1);
    }

    .theme-toggle-header {
      background: transparent;
      border: none;
      color: var(--light);
      cursor: pointer;
      font-size: 1.2rem;
      transition: color 0.3s;
      padding: var(--spacing-sm);
    }

    body.light-mode .theme-toggle-header {
      color: var(--dark);
    }

    .theme-toggle-header:hover {
      color: var(--primary);
    }

    .show-toggle-header {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-base);
      border-radius: 3px;
      cursor: pointer;
      margin: 0 var(--spacing-sm);
      transition: background 0.3s;
      font-size: 0.8rem;
      visibility: visible;
      position: relative;
    }

    .show-toggle-header:hover {
      background: var(--primary-dark);
    }

    .dropdown-header {
      display: none;
      position: absolute;
      background: var(--dark-gray);
      border-radius: 3px;
      box-shadow: var(--shadow);
      z-index: 100;
      min-width: 120px;
      right: 0;
      top: 100%;
      margin-top: var(--spacing-sm);
    }

    body.light-mode .dropdown-header {
      background: #e0e0e0;
    }

    .dropdown-header.show {
      display: block;
    }

    .dropdown-header a {
      color: var(--light);
      padding: var(--spacing-sm) var(--spacing-base);
      text-decoration: none;
      display: block;
      font-size: 0.8rem;
    }

    body.light-mode .dropdown-header a {
      color: var(--dark);
    }

    .dropdown-header a:hover {
      background: var(--primary-light);
      color: white;
    }

    .genre-dropdown {
      display: none;
      position: absolute;
      background: var(--dark-gray);
      border-radius: 3px;
      box-shadow: var(--shadow);
      z-index: 100;
      min-width: 150px;
      right: 0;
      top: 100%;
      margin-top: var(--spacing-sm);
    }

    body.light-mode .genre-dropdown {
      background: #e0e0e0;
    }

    .genre-dropdown.show {
      display: block;
    }

    .genre-dropdown a {
      color: var(--light);
      padding: var(--spacing-sm) var(--spacing-base);
      text-decoration: none;
      display: block;
      font-size: 0.8rem;
    }

    body.light-mode .genre-dropdown a {
      color: var(--dark);
    }

    .genre-dropdown a:hover {
      background: var(--primary-light);
      color: white;
    }

    .section {
      padding: var(--spacing-base) var(--spacing-sm);
      background: var(--dark);
      min-height: 100vh;
      scroll-snap-align: start;
    }

    body.light-mode .section {
      background: var(--light);
    }

    .section-title {
      font-size: 1.2rem;
      margin-bottom: var(--spacing-sm);
      color: var(--primary);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--primary);
    }

    .movies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: var(--spacing-sm);
      padding: var(--spacing-sm);
      will-change: transform;
    }

    .movie-card {
      background: var(--dark-gray);
      border-radius: 6px;
      overflow: hidden;
      transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
      position: relative;
      cursor: pointer;
      min-width: 120px;
      min-height: 200px;
      will-change: transform;
    }

    body.light-mode .movie-card {
      background: #e0e0e0;
    }

    .movie-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    .movie-poster {
      width: 100%;
      height: 150px;
      object-fit: cover;
      display: block;
      transition: opacity 0.3s;
    }

    .movie-info {
      padding: var(--spacing-sm);
    }

    .movie-title {
      font-size: 0.8rem;
      margin-bottom: var(--spacing-sm);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .movie-meta {
      display: flex;
      justify-content: space-between;
      color: var(--gray);
      font-size: 0.7rem;
    }

    .movie-rating {
      color: gold;
    }

    .time-indicator {
      font-size: 0.6rem;
      color: var(--gray);
      margin-top: var(--spacing-sm);
    }

    .movie-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease-out;
      padding: var(--spacing-sm);
      text-align: center;
    }

    .movie-card:hover .movie-overlay {
      opacity: 1;
    }

    .overlay-title {
      font-size: 0.85rem;
      margin-bottom: var(--spacing-sm);
      color: white;
    }

    .overlay-genres {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      justify-content: center;
    }

    .genre-tag {
      background: var(--primary);
      color: white;
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-size: 0.6rem;
    }

    .overlay-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-base);
      border-radius: 3px;
      cursor: pointer;
      margin-top: var(--spacing-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      transition: background 0.3s ease-out;
      font-size: 0.7rem;
    }

    .overlay-btn:hover {
      background: var(--primary-dark);
    }

    .watchlist-btn {
      background: #333;
    }

    .watchlist-btn.in-watchlist {
      background: #4CAF50;
    }

    .umusobanuzi {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 0.1rem 0.2rem;
      border-radius: 3px;
      font-size: 0.6rem;
      z-index: 10;
    }

    .spinner {
      display: none;
      width: 24px;
      height: 24px;
      margin: var(--spacing-base) auto;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner.active {
      display: block;
    }

    .copyright-text {
      text-align: center;
      padding: var(--spacing-base) 0;
      color: var(--gray);
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .social-icons {
      text-align: center;
      padding: var(--spacing-sm) 0;
      flex-shrink: 0;
    }

    .social-icons a {
      color: var(--gray);
      font-size: 1.2rem;
      margin: 0 var(--spacing-sm);
      transition: color 0.3s ease-out;
    }

    .social-icons a:hover {
      color: var(--primary);
    }

    /* Smooth scrolling container */
    .scroll-container {
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
      flex-grow: 1;
    }

    /* Custom scrollbar for WebKit browsers */
    .scroll-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .scroll-container::-webkit-scrollbar-track {
      background: var(--dark-gray);
    }

    .scroll-container::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 4px;
    }

    body.light-mode .scroll-container::-webkit-scrollbar-track {
      background: #e0e0e0;
    }

    body.light-mode .scroll-container::-webkit-scrollbar-thumb {
      background: var(--primary-dark);
    }

    @media (max-width: 768px) {
      .movies-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      .movie-poster {
        height: 130px;
      }
      .movie-title {
        font-size: 0.75rem;
      }
      .movie-meta {
        font-size: 0.65rem;
      }
      .time-indicator {
        font-size: 0.55rem;
      }
      .overlay-title {
        font-size: 0.8rem;
      }
      .genre-tag {
        font-size: 0.55rem;
        padding: 0.1rem 0.2rem;
      }
      .overlay-btn {
        padding: var(--spacing-sm) var(--spacing-sm);
        font-size: 0.65rem;
      }
      .umusobanuzi {
        top: 3px;
        left: 3px;
        padding: 0.1rem 0.2rem;
        font-size: 0.55rem;
      }
      header {
        padding: var(--spacing-sm) var(--spacing-sm);
        flex-direction: column;
        align-items: flex-start;
      }
      .header-left, .header-right {
        width: 100%;
        justify-content: space-between;
      }
      .show-toggle-header {
        padding: var(--spacing-sm) var(--spacing-sm);
        font-size: 0.7rem;
      }
      .section {
        padding: var(--spacing-sm);
      }
    }

    @media (max-width: 576px) {
      .movies-grid {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: var(--spacing-sm);
      }
      .movie-poster {
        height: 120px;
      }
      .movie-title {
        font-size: 0.7rem;
      }
      .movie-meta {
        font-size: 0.6rem;
      }
      .time-indicator {
        font-size: 0.5rem;
      }
      .overlay-title {
        font-size: 0.75rem;
      }
      .genre-tag {
        font-size: 0.5rem;
        padding: 0.1rem 0.2rem;
      }
      .overlay-btn {
        padding: var(--spacing-sm) var(--spacing-sm);
        font-size: 0.6rem;
      }
      .umusobanuzi {
        top: 2px;
        left: 2px;
        padding: 0.1rem 0.1rem;
        font-size: 0.5rem;
      }
      .show-toggle-header {
        padding: var(--spacing-sm) var(--spacing-sm);
        font-size: 0.6rem;
      }
      .section-title {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="main-content">
    <header>
      <div class="header-left">
        <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> BACK</a>
      </div>
      <div class="header-right">
        <button class="show-toggle-header" id="show-toggle-header">Show</button>
        <div class="dropdown-header" id="dropdown-header">
          <a href="#" data-type="abasobanuzi">Abasobanuzi only</a>
          <a href="#" data-type="genres">Genres only</a>
          <a href="#" data-type="all">All</a>
          <a href="#" id="choose-genre">Choose</a>
        </div>
        <div class="genre-dropdown" id="genre-dropdown">
          <a href="#" data-genre="Action">Action</a>
          <a href="#" data-genre="Adventure">Adventure</a>
          <a href="#" data-genre="Animation">Animation</a>
          <a href="#" data-genre="Comedy">Comedy</a>
          <a href="#" data-genre="Crime">Crime</a>
          <a href="#" data-genre="Drama">Drama</a>
          <a href="#" data-genre="Horror">Horror</a>
          <a href="#" data-genre="Romance">Romance</a>
          <a href="#" data-genre="Adult">Adult</a>
          <a href="#" data-genre="War">War</a>
          <a href="#" data-genre="Thriller">Thriller</a>
          <a href="#" data-genre="Indian">Indian</a>
          <a href="#" data-genre="Sci-Fi">Sci-Fi</a>
          <a href="#" data-genre="Sport">Sport</a>
        </div>
        <button class="theme-toggle-header"><i class="fas fa-moon"></i></button>
      </div>
    </header>
    
    <div class="scroll-container" id="scroll-container">
      <main id="main-content">
        <div class="spinner active" id="loading-spinner"></div>
      </main>

      <div class="copyright-text">Â© 2025 KINAFLIX by btem@fficial</div>
      <div class="social-icons">
        <a href="https://www.youtube.com/@kinaflix" target="_blank"><i class="fab fa-youtube"></i></a>
        <a href="https://www.instagram.com/kinaflix_official" target="_blank"><i class="fab fa-instagram"></i></a>
      </div>
    </div>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-analytics.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";
import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc, updateDoc, arrayUnion, arrayRemove, where, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCBrRTdhrRTRL9ZfZpb-m-1XBmbDIsXF9k",
    authDomain: "kinaflix.firebaseapp.com",
    databaseURL: "https://kinaflix-default-rtdb.firebaseio.com",
    projectId: "kinaflix",
    storageBucket: "kinaflix.firebasestorage.app",
    messagingSenderId: "318239806217",
    appId: "1:318239806217:web:421533021d4a2bf43239d8",
    measurementId: "G-GVW6CMN8DS"
};

const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
const auth = getAuth(app);
const db = getFirestore(app);

let mainContent = document.getElementById('main-content');
let scrollContainer = document.getElementById('scroll-container');
let loadingSpinner = document.getElementById('loading-spinner');
let showToggleHeader = document.getElementById('show-toggle-header');
let dropdownHeader = document.getElementById('dropdown-header');
let genreDropdown = document.getElementById('genre-dropdown');

let currentUser = null;
let movies = [];
let watchlist = [];
let watchHistory = [];
let themeToggleTimeout;
let watchTimeStart = null;

const cache = {
  movies: null,
  expiry: 5 * 60 * 1000
};

// Watch Time Tracking
function startWatchTimeTracking() {
  if (!currentUser) return;
  const now = new Date();
  const hours = now.getHours();
  if (hours >= 6 && hours < 12) {
    console.log('Watch time tracking skipped: Time is between 06:00 and 12:00');
    return;
  }
  watchTimeStart = performance.now();
  console.log('Watch time tracking started at:', new Date().toISOString());
}

async function stopWatchTimeTracking() {
  if (!currentUser || !watchTimeStart) return;
  const now = new Date();
  const hours = now.getHours();
  if (hours >= 6 && hours < 12) {
    console.log('Watch time tracking skipped on stop: Time is between 06:00 and 12:00');
    watchTimeStart = null;
    return;
  }
  const timeSpent = Math.round((performance.now() - watchTimeStart) / 1000);
  if (timeSpent <= 0) {
    console.log('Watch time tracking stopped: No time to record');
    return;
  }

  const date = now.toISOString().split('T')[0];
  const userRef = doc(db, 'plusers', currentUser.uid);
  const sessionRef = doc(db, 'plusers', currentUser.uid, 'watch_sessions', date);

  try {
    await setDoc(sessionRef, {
      date: date,
      watchTime: increment(timeSpent),
      lastUpdated: serverTimestamp()
    }, { merge: true });

    await updateDoc(userRef, {
      total_watch_time: increment(timeSpent)
    });
    console.log(`Watch time saved: ${timeSpent} seconds for ${date}`);
  } catch (error) {
    console.error('Error saving watch time:', error);
  }
  watchTimeStart = null;
}

document.addEventListener('DOMContentLoaded', () => {
  // Delay initialization to ensure DOM is fully loaded
  setTimeout(() => {
    // Re-query elements in case they were modified
    mainContent = document.getElementById('main-content');
    scrollContainer = document.getElementById('scroll-container');
    loadingSpinner = document.getElementById('loading-spinner');
    showToggleHeader = document.getElementById('show-toggle-header');
    dropdownHeader = document.getElementById('dropdown-header');
    genreDropdown = document.getElementById('genre-dropdown');

    // Log DOM state for debugging
    console.log('DOM state check:', {
      mainContent: !!mainContent,
      scrollContainer: !!scrollContainer,
      loadingSpinner: !!loadingSpinner,
      showToggleHeader: !!showToggleHeader,
      dropdownHeader: !!dropdownHeader,
      genreDropdown: !!genreDropdown,
      themeToggles: document.querySelectorAll('.theme-toggle-header').length
    });

    if (!mainContent) console.warn('Main content element not found');
    if (!scrollContainer) console.warn('Scroll container element not found');
    if (!loadingSpinner) console.warn('Loading spinner element not found');
    if (!showToggleHeader) console.warn('Show toggle header element not found');
    if (!dropdownHeader) console.warn('Dropdown header element not found');
    if (!genreDropdown) console.warn('Genre dropdown element not found');

    initAuth();
    initUI();
    loadGenreOrUmusobanuziPage();
    loadWatchHistoryFromCookies();
    initInfiniteScroll();
    startWatchTimeTracking();
    window.addEventListener('beforeunload', stopWatchTimeTracking);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        stopWatchTimeTracking();
      } else if (document.visibilityState === 'visible') {
        startWatchTimeTracking();
      }
    });

    // Monitor DOM changes for debugging
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(mutation => {
        if (mutation.removedNodes.length) {
          mutation.removedNodes.forEach(node => {
            if (node.id === 'main-content' || node.id === 'scroll-container' || node.id === 'loading-spinner' ||
                node.id === 'show-toggle-header' || node.id === 'dropdown-header' || node.id === 'genre-dropdown' ||
                node.classList?.contains('theme-toggle-header')) {
              console.warn(`Critical element removed: ${node.id || node.className}`);
            }
          });
        }
      });
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }, 100);
});

function initAuth() {
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await loadUserData(user.uid);
      startWatchTimeTracking();
    } else {
      currentUser = null;
      stopWatchTimeTracking();
    }
  });
}

function initUI() {
  const themeToggles = document.querySelectorAll('.theme-toggle-header');
  if (themeToggles.length === 0) {
    console.warn('No theme toggle buttons found');
  } else {
    themeToggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        clearTimeout(themeToggleTimeout);
        themeToggleTimeout = setTimeout(toggleTheme, 100);
      });
    });
  }

  const savedTheme = localStorage.getItem('theme') || (navigator.cookieEnabled ? localStorage.getItem('theme') : null);
  if (savedTheme === 'light') {
    document.body.classList.add('light-mode');
    document.querySelectorAll('.theme-toggle-header i').forEach(icon => {
      if (icon) {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      }
    });
  }

  if (!showToggleHeader) {
    console.warn('Show toggle header element not found');
    return;
  }
  showToggleHeader.addEventListener('click', (e) => {
    e.preventDefault();
    if (dropdownHeader) {
      dropdownHeader.classList.toggle('show');
      if (genreDropdown) genreDropdown.classList.remove('show');
    }
  });

  if (!dropdownHeader) {
    console.warn('Dropdown header element not found');
  } else {
    dropdownHeader.addEventListener('click', (e) => {
      const type = e.target.getAttribute('data-type');
      if (type) {
        localStorage.removeItem('selectedGenre');
        localStorage.setItem('displayType', type);
        dropdownHeader.classList.remove('show');
        loadGenreOrUmusobanuziPage();
      } else if (e.target.id === 'choose-genre') {
        e.preventDefault();
        if (genreDropdown) {
          genreDropdown.classList.toggle('show');
          dropdownHeader.classList.remove('show');
        }
      }
    });
  }

  if (!genreDropdown) {
    console.warn('Genre dropdown element not found');
  } else {
    genreDropdown.addEventListener('click', (e) => {
      const genre = e.target.getAttribute('data-genre');
      if (genre) {
        localStorage.setItem('selectedGenre', genre);
        localStorage.removeItem('displayType');
        genreDropdown.classList.remove('show');
        loadGenreOrUmusobanuziPage();
      }
    });
  }

  document.addEventListener('click', (e) => {
    if (showToggleHeader && dropdownHeader && genreDropdown &&
        !showToggleHeader.contains(e.target) &&
        !dropdownHeader.contains(e.target) &&
        !genreDropdown.contains(e.target)) {
      dropdownHeader.classList.remove('show');
      genreDropdown.classList.remove('show');
    }
  });
}

function toggleTheme() {
  document.body.classList.toggle('light-mode');
  const icons = document.querySelectorAll('.theme-toggle-header i');
  if (document.body.classList.contains('light-mode')) {
    icons.forEach(icon => {
      if (icon) {
        icon.classList.remove('fa-moon');
        icon.classList.add('fa-sun');
      }
    });
    if (navigator.cookieEnabled) localStorage.setItem('theme', 'light');
  } else {
    icons.forEach(icon => {
      if (icon) {
        icon.classList.remove('fa-sun');
        icon.classList.add('fa-moon');
      }
    });
    if (navigator.cookieEnabled) localStorage.setItem('theme', 'dark');
  }
}

async function loadGenreOrUmusobanuziPage() {
  showLoading();
  try {
    movies = await getCachedData('movies', fetchMovies);
    const selectedGenre = localStorage.getItem('selectedGenre');
    let displayType = localStorage.getItem('displayType');
    if (!displayType && !selectedGenre) displayType = 'all';

    let html = '';
    if (!selectedGenre) {
      if (displayType === 'abasobanuzi') {
        const umusobanuziOrder = ['Subtitled', 'Dubbed', 'Kinyarwanda', 'Others', ''];
        const groupedByUmusobanuzi = {};

        movies.forEach(movie => {
          const key = movie.umusobanuzi || '';
          if (!groupedByUmusobanuzi[key]) {
            groupedByUmusobanuzi[key] = [];
          }
          groupedByUmusobanuzi[key].push(movie);
        });

        const sortedGroups = [];
        umusobanuziOrder.forEach(key => {
          if (groupedByUmusobanuzi[key]) {
            sortedGroups.push({
              umusobanuzi: key,
              movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
            });
            delete groupedByUmusobanuzi[key];
          }
        });

        Object.keys(groupedByUmusobanuzi).forEach(key => {
          sortedGroups.push({
            umusobanuzi: key,
            movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
          });
        });

        html = sortedGroups.map(group => `
          <section class="section umusobanuzi-section">
            <h2 class="section-title">${group.umusobanuzi || 'Unspecified'} Movies</h2>
            <div class="movies-grid">
              ${group.movies.map(movie => renderMovieCard(movie)).join('')}
            </div>
          </section>
        `).join('');
      } else if (displayType === 'genres') {
        const genres = ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Drama', 'Horror', 'Romance', 'Adult', 'War', 'Thriller', 'Indian', 'Sci-Fi', 'Sport'];
        const groupedByGenre = {};

        movies.forEach(movie => {
          if (Array.isArray(movie.genres)) {
            movie.genres.forEach(genre => {
              if (!groupedByGenre[genre]) {
                groupedByGenre[genre] = [];
              }
              groupedByGenre[genre].push(movie);
            });
          }
        });

        html = genres.map(genre => {
          const genreMovies = groupedByGenre[genre] || [];
          return `
            <section class="section umusobanuzi-section">
              <h2 class="section-title">${genre} Movies</h2>
              <div class="movies-grid">
                ${genreMovies.sort((a, b) => b.releaseYear - a.releaseYear).map(movie => renderMovieCard(movie)).join('')}
              </div>
            </section>
          `;
        }).join('');
      } else { // 'all'
        const umusobanuziOrder = ['Subtitled', 'Dubbed', 'Kinyarwanda', 'Others', ''];
        const groupedByUmusobanuzi = {};

        movies.forEach(movie => {
          const key = movie.umusobanuzi || '';
          if (!groupedByUmusobanuzi[key]) {
            groupedByUmusobanuzi[key] = [];
          }
          groupedByUmusobanuzi[key].push(movie);
        });

        const sortedGroups = [];
        umusobanuziOrder.forEach(key => {
          if (groupedByUmusobanuzi[key]) {
            sortedGroups.push({
              umusobanuzi: key,
              movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
            });
            delete groupedByUmusobanuzi[key];
          }
        });

        Object.keys(groupedByUmusobanuzi).forEach(key => {
          sortedGroups.push({
            umusobanuzi: key,
            movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
          });
        });

        html = sortedGroups.map(group => `
          <section class="section umusobanuzi-section">
            <h2 class="section-title">${group.umusobanuzi || 'All'} Movies</h2>
            <div class="movies-grid">
              ${group.movies.map(movie => renderMovieCard(movie)).join('')}
            </div>
          </section>
        `).join('');
      }

      if (html === '') {
        html = '<section class="section"><p>No movies found.</p></section>';
      }
    } else {
      const genreMovies = movies.filter(movie => 
        Array.isArray(movie.genres) && movie.genres.includes(selectedGenre)
      ).sort((a, b) => b.releaseYear - a.releaseYear);

      html = genreMovies.length > 0 ? `
        <section class="section">
          <h2 class="section-title">${selectedGenre} Movies</h2>
          <div class="movies-grid">
            ${genreMovies.map(movie => renderMovieCard(movie)).join('')}
          </div>
        </section>
      ` : `<section class="section"><p>No movies found for ${selectedGenre}.</p></section>`;
    }

    if (mainContent) {
      mainContent.innerHTML = html;
      attachMovieCardEvents();
    } else {
      console.warn('Cannot render movies: main-content element is missing');
    }
    hideLoading();
  } catch (error) {
    console.error('Error loading page:', error);
    hideLoading();
  }
}

async function getCachedData(key, fetchFn) {
  const cached = sessionStorage.getItem(key) || (navigator.cookieEnabled ? sessionStorage.getItem(key) : null);
  if (cached) {
    const { data, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp < cache.expiry) {
      return data;
    }
  }
  const data = await fetchFn();
  if (navigator.cookieEnabled) sessionStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
  cache[key] = data;
  return data;
}

async function fetchMovies() {
  const q = query(collection(db, 'movies'), orderBy('releaseYear', 'desc'));
  const querySnapshot = await getDocs(q);
  return querySnapshot.docs
    .map(doc => ({
      id: doc.id,
      title: doc.data().title || '',
      description: doc.data().description || '',
      genres: Array.isArray(doc.data().genres) ? doc.data().genres : [],
      releaseYear: typeof doc.data().releaseYear === 'number' ? doc.data().releaseYear : 0,
      coverImageUrl: doc.data().coverImageUrl || '',
      googleDriveLink: doc.data().googleDriveLink || '',
      youtubeLink: doc.data().youtubeLink || '',
      umusobanuzi: doc.data().umusobanuzi || '',
      timestamp: doc.data().dateAdded?.toDate() || new Date()
    }))
    .filter(movie => movie.title);
}

function renderMovieCard(movie) {
  const inWatchlist = currentUser && watchlist.includes(movie.id);
  const timeSince = formatTimeSince(movie.timestamp);
  return `
    <div class="movie-card" data-movie-id="${movie.id}">
      ${movie.umusobanuzi ? `<span class="umusobanuzi">${movie.umusobanuzi}</span>` : ''}
      <img src="${movie.coverImageUrl || '/images/fallback.jpg'}" 
           alt="${movie.title}" class="movie-poster" loading="lazy">
      <div class="movie-info">
        <h3 class="movie-title">${movie.title} (${movie.releaseYear || 'N/A'})</h3>
        <div class="movie-meta">
          <span>${movie.releaseYear || 'N/A'}</span>
          ${movie.rating ? `<span class="movie-rating"><i class="fas fa-star"></i> ${movie.rating}</span>` : ''}
        </div>
        <div class="time-indicator">${timeSince}</div>
      </div>
      <div class="movie-overlay">
        <h3 class="overlay-title">${movie.title}</h3>
        ${Array.isArray(movie.genres) && movie.genres.length ? `
          <div class="overlay-genres">
            ${movie.genres.map(genre => `<span class="genre-tag">${genre}</span>`).join('')}
          </div>
        ` : ''}
        <p>${movie.description?.substring(0, 80) || 'No description available'}...</p>
        <button class="overlay-btn" data-movie-id="${movie.id}"><i class="fas fa-play"></i> Watch Now</button>
        ${currentUser ? `
          <button class="overlay-btn watchlist-btn ${inWatchlist ? 'in-watchlist' : ''}" 
                  data-movie-id="${movie.id}">
            <i class="fas ${inWatchlist ? 'fa-check' : 'fa-plus'}"></i> 
            ${inWatchlist ? 'In Watchlist' : 'Add to Watchlist'}
          </button>
        ` : ''}
      </div>
    </div>
  `;
}

function formatTimeSince(timestamp) {
  const now = new Date();
  const seconds = Math.floor((now - timestamp) / 1000);
  let interval = Math.floor(seconds / 31536000);
  if (interval >= 1) return `${interval} year${interval === 1 ? '' : 's'} ago`;
  interval = Math.floor(seconds / 2592000);
  if (interval >= 1) return `${interval} month${interval === 1 ? '' : 's'} ago`;
  interval = Math.floor(seconds / 86400);
  if (interval >= 1) return `${interval} day${interval === 1 ? '' : 's'} ago`;
  interval = Math.floor(seconds / 3600);
  if (interval >= 1) return `${interval} hour${interval === 1 ? '' : 's'} ago`;
  interval = Math.floor(seconds / 60);
  if (interval >= 1) return `${interval} minute${interval === 1 ? '' : 's'} ago`;
  return `${Math.floor(seconds)} second${seconds === 1 ? '' : 's'} ago`;
}

async function loadUserData(userId) {
  try {
    const userRef = doc(db, 'plusers', userId);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const userData = userSnap.data();
      watchlist = userData.watchlist || [];
      watchHistory = (userData.history || []).filter(id => movies.some(m => m.id === id));
      await updateDoc(userRef, { history: watchHistory });
      saveWatchHistoryToCookies(watchHistory);
    }
  } catch (error) {
    console.error('Error loading user data:', error);
  }
}

function attachMovieCardEvents() {
  if (!mainContent) {
    console.warn('Cannot attach movie card events: main-content element is missing');
    return;
  }
  mainContent.addEventListener('click', async (e) => {
    const target = e.target.closest('.movie-card, .overlay-btn:not(.watchlist-btn), .watchlist-btn');
    if (!target) return;
    if (target.classList.contains('watchlist-btn')) {
      e.preventDefault();
      e.stopPropagation();
      const movieId = target.getAttribute('data-movie-id');
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }
      try {
        const userRef = doc(db, 'plusers', currentUser.uid);
        if (watchlist.includes(movieId)) {
          await updateDoc(userRef, { watchlist: arrayRemove(movieId) });
          watchlist = watchlist.filter(id => id !== movieId);
          target.classList.remove('in-watchlist');
          target.innerHTML = `<i class="fas fa-plus"></i> Add to Watchlist`;
        } else {
          await updateDoc(userRef, { watchlist: arrayUnion(movieId) });
          watchlist.push(movieId);
          target.classList.add('in-watchlist');
          target.innerHTML = `<i class="fas fa-check"></i> In Watchlist`;
        }
      } catch (error) {
        console.error('Error updating watchlist:', error);
      }
    } else {
      const movieId = target.getAttribute('data-movie-id') || target.closest('.movie-card')?.getAttribute('data-movie-id');
      if (movieId) {
        if (currentUser) {
          const userRef = doc(db, 'plusers', currentUser.uid);
          watchHistory = Array.from(new Set([movieId, ...watchHistory])).slice(0, 100);
          await updateDoc(userRef, { history: watchHistory });
          saveWatchHistoryToCookies(watchHistory);
        }
        window.location.href = `see.html?id=${movieId}`;
      }
    }
  });

  mainContent.addEventListener('touchend', (e) => {
    const target = e.target.closest('.movie-card, .overlay-btn:not(.watchlist-btn), .watchlist-btn');
    if (!target) return;
    e.preventDefault();
    const movieId = target.getAttribute('data-movie-id') || target.closest('.movie-card')?.getAttribute('data-movie-id');
    if (target.classList.contains('watchlist-btn')) {
      if (!currentUser) {
        window.location.href = 'login.html';
        return;
      }
      // Simulate click event for watchlist button
      const clickEvent = new Event('click', { bubbles: true });
      target.dispatchEvent(clickEvent);
    } else if (movieId) {
      if (currentUser) {
        const userRef = doc(db, 'plusers', currentUser.uid);
        watchHistory = Array.from(new Set([movieId, ...watchHistory])).slice(0, 100);
        updateDoc(userRef, { history: watchHistory }).then(() => saveWatchHistoryToCookies(watchHistory));
      }
      window.location.href = `see.html?id=${movieId}`;
    }
  });
}

function saveWatchHistoryToCookies(history) {
  if (navigator.cookieEnabled) document.cookie = `watchHistory=${JSON.stringify(history)}; path=/; max-age=${30 * 24 * 60 * 60}`;
}

function loadWatchHistoryFromCookies() {
  const cookies = document.cookie.split('; ');
  const historyCookie = cookies.find(c => c.startsWith('watchHistory='));
  if (historyCookie) {
    try {
      watchHistory = JSON.parse(historyCookie.split('=')[1]) || [];
    } catch (e) {
      watchHistory = [];
    }
  }
}

function showLoading() {
  if (loadingSpinner) loadingSpinner.classList.add('active');
}

function hideLoading() {
  if (loadingSpinner) loadingSpinner.classList.remove('active');
}

function initInfiniteScroll() {
  let isLoading = false;
  let lastScrollTop = 0;
  let lastScrollLeft = 0;

  const loadMore = async () => {
    if (isLoading) return;
    isLoading = true;
    showLoading();

    await new Promise(resolve => setTimeout(resolve, 1000));
    const newMovies = await fetchMovies();
    movies = [...movies, ...newMovies.filter(m => !movies.some(existing => existing.id === m.id))];

    const selectedGenre = localStorage.getItem('selectedGenre');
    let displayType = localStorage.getItem('displayType') || 'all';
    let html = '';

    if (!selectedGenre) {
      if (displayType === 'abasobanuzi') {
        const umusobanuziOrder = ['Subtitled', 'Dubbed', 'Kinyarwanda', 'Others', ''];
        const groupedByUmusobanuzi = {};

        movies.forEach(movie => {
          const key = movie.umusobanuzi || '';
          if (!groupedByUmusobanuzi[key]) {
            groupedByUmusobanuzi[key] = [];
          }
          groupedByUmusobanuzi[key].push(movie);
        });

        const sortedGroups = [];
        umusobanuziOrder.forEach(key => {
          if (groupedByUmusobanuzi[key]) {
            sortedGroups.push({
              umusobanuzi: key,
              movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
            });
            delete groupedByUmusobanuzi[key];
          }
        });

        Object.keys(groupedByUmusobanuzi).forEach(key => {
          sortedGroups.push({
            umusobanuzi: key,
            movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
          });
        });

        html = sortedGroups.map(group => `
          <section class="section umusobanuzi-section">
            <h2 class="section-title">${group.umusobanuzi || 'Unspecified'} Movies</h2>
            <div class="movies-grid">
              ${group.movies.map(movie => renderMovieCard(movie)).join('')}
            </div>
          </section>
        `).join('');
      } else if (displayType === 'genres') {
        const genres = ['Action', 'Adventure', 'Animation', 'Comedy', 'Crime', 'Drama', 'Horror', 'Romance', 'Adult', 'War', 'Thriller', 'Indian', 'Sci-Fi', 'Sport'];
        const groupedByGenre = {};

        movies.forEach(movie => {
          if (Array.isArray(movie.genres)) {
            movie.genres.forEach(genre => {
              if (!groupedByGenre[genre]) {
                groupedByGenre[genre] = [];
              }
              groupedByGenre[genre].push(movie);
            });
          }
        });

        html = genres.map(genre => {
          const genreMovies = groupedByGenre[genre] || [];
          return `
            <section class="section umusobanuzi-section">
              <h2 class="section-title">${genre} Movies</h2>
              <div class="movies-grid">
                ${genreMovies.sort((a, b) => b.releaseYear - a.releaseYear).map(movie => renderMovieCard(movie)).join('')}
              </div>
            </section>
          `;
        }).join('');
      } else { // 'all'
        const umusobanuziOrder = ['Subtitled', 'Dubbed', 'Kinyarwanda', 'Others', ''];
        const groupedByUmusobanuzi = {};

        movies.forEach(movie => {
          const key = movie.umusobanuzi || '';
          if (!groupedByUmusobanuzi[key]) {
            groupedByUmusobanuzi[key] = [];
          }
          groupedByUmusobanuzi[key].push(movie);
        });

        const sortedGroups = [];
        umusobanuziOrder.forEach(key => {
          if (groupedByUmusobanuzi[key]) {
            sortedGroups.push({
              umusobanuzi: key,
              movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
            });
            delete groupedByUmusobanuzi[key];
          }
        });

        Object.keys(groupedByUmusobanuzi).forEach(key => {
          sortedGroups.push({
            umusobanuzi: key,
            movies: groupedByUmusobanuzi[key].sort((a, b) => b.releaseYear - a.releaseYear)
          });
        });

        html = sortedGroups.map(group => `
          <section class="section umusobanuzi-section">
            <h2 class="section-title">${group.umusobanuzi || 'All'} Movies</h2>
            <div class="movies-grid">
              ${group.movies.map(movie => renderMovieCard(movie)).join('')}
            </div>
          </section>
        `).join('');
      }
    } else {
      const genreMovies = movies.filter(movie => 
        Array.isArray(movie.genres) && movie.genres.includes(selectedGenre)
      ).sort((a, b) => b.releaseYear - a.releaseYear);

      html = genreMovies.length > 0 ? `
        <section class="section">
          <h2 class="section-title">${selectedGenre} Movies</h2>
          <div class="movies-grid">
            ${genreMovies.map(movie => renderMovieCard(movie)).join('')}
          </div>
        </section>
      ` : `<section class="section"><p>No movies found for ${selectedGenre}.</p></section>`;
    }

    if (mainContent) {
      mainContent.innerHTML += html;
      attachMovieCardEvents();
    } else {
      console.warn('Cannot render additional movies: main-content element is missing');
    }
    isLoading = false;
    hideLoading();
  };

  if (scrollContainer) {
    scrollContainer.addEventListener('scroll', () => {
      const scrollTop = scrollContainer.scrollTop;
      const scrollLeft = scrollContainer.scrollLeft;
      const clientHeight = scrollContainer.clientHeight;
      const clientWidth = scrollContainer.clientWidth;
      const scrollHeight = scrollContainer.scrollHeight;
      const scrollWidth = scrollContainer.scrollWidth;

      if ((scrollTop + clientHeight >= scrollHeight - 100 || scrollLeft + clientWidth >= scrollWidth - 100) &&
          (scrollTop !== lastScrollTop || scrollLeft !== lastScrollLeft)) {
        loadMore();
      }
      lastScrollTop = scrollTop;
      lastScrollLeft = scrollLeft;
    });
  } else {
    console.warn('Cannot initialize infinite scroll: scroll-container element is missing');
  }

  loadMore();
}
</script>
</body>
</html>
